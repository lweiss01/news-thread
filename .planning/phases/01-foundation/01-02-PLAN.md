---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/src/main/java/com/newsthread/app/presentation/feed/FeedScreen.kt
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees feedback when app is operating in rate-limited mode"
    - "Feedback shows time remaining until rate limit expires"
    - "Snackbar appears when feed loads while rate limited"
  artifacts:
    - path: "app/src/main/java/com/newsthread/app/presentation/feed/FeedScreen.kt"
      provides: "Rate limit UI feedback via Snackbar"
      contains: "SnackbarHost"
  key_links:
    - from: "FeedViewModel"
      to: "QuotaRepository"
      via: "@Inject constructor"
      pattern: "quotaRepository"
    - from: "FeedScreen"
      to: "isRateLimited state"
      via: "collectAsStateWithLifecycle"
      pattern: "isRateLimited.*collectAsStateWithLifecycle"
---

<objective>
Close verification gap: Add user feedback when API is rate limited

Purpose: Phase 1 Truth 3 requires "App detects NewsAPI 429 responses and shows user feedback without crashing." Detection infrastructure exists (RateLimitInterceptor, QuotaRepository), but the UI layer does not inform users when the app is operating from cached data due to rate limiting.

Output: FeedScreen shows Snackbar when QuotaRepository indicates rate-limited state, with message showing time until rate limit expires.
</objective>

<execution_context>
@C:\Users\lweis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lweis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

Key files:
@app/src/main/java/com/newsthread/app/data/repository/QuotaRepository.kt
@app/src/main/java/com/newsthread/app/domain/model/ApiQuotaState.kt
@app/src/main/java/com/newsthread/app/presentation/feed/FeedScreen.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire QuotaRepository to FeedViewModel and show Snackbar</name>
  <files>app/src/main/java/com/newsthread/app/presentation/feed/FeedScreen.kt</files>
  <action>
Modify FeedViewModel (embedded in FeedScreen.kt):

1. Add QuotaRepository to constructor injection:
   ```kotlin
   @HiltViewModel
   class FeedViewModel @Inject constructor(
       private val newsRepository: NewsRepository,
       private val sourceRatingRepository: SourceRatingRepository,
       private val quotaRepository: QuotaRepository  // ADD
   ) : ViewModel()
   ```

2. Add rate limit state flow in FeedViewModel:
   ```kotlin
   private val _isRateLimited = MutableStateFlow(false)
   val isRateLimited: StateFlow<Boolean> = _isRateLimited.asStateFlow()

   private val _rateLimitMinutesRemaining = MutableStateFlow(0)
   val rateLimitMinutesRemaining: StateFlow<Int> = _rateLimitMinutesRemaining.asStateFlow()
   ```

3. Add function to check rate limit state (call from init block and loadHeadlines):
   ```kotlin
   private fun checkRateLimitState() {
       viewModelScope.launch {
           val isLimited = quotaRepository.isRateLimitedSync()
           _isRateLimited.value = isLimited
           if (isLimited) {
               val untilMillis = quotaRepository.getRateLimitedUntil()
               val remainingMs = untilMillis - System.currentTimeMillis()
               _rateLimitMinutesRemaining.value = (remainingMs / 60_000).toInt().coerceAtLeast(1)
           }
       }
   }
   ```

4. Call checkRateLimitState() in init block and after loadHeadlines() completes.

Modify FeedScreen composable:

5. Add imports at top:
   ```kotlin
   import androidx.compose.material3.Snackbar
   import androidx.compose.material3.SnackbarHost
   import androidx.compose.material3.SnackbarHostState
   import androidx.compose.runtime.LaunchedEffect
   import androidx.compose.runtime.remember
   ```

6. Collect rate limit state:
   ```kotlin
   val isRateLimited by viewModel.isRateLimited.collectAsStateWithLifecycle()
   val rateLimitMinutes by viewModel.rateLimitMinutesRemaining.collectAsStateWithLifecycle()
   ```

7. Add SnackbarHostState and show Snackbar when rate limited:
   ```kotlin
   val snackbarHostState = remember { SnackbarHostState() }

   LaunchedEffect(isRateLimited, rateLimitMinutes) {
       if (isRateLimited) {
           snackbarHostState.showSnackbar(
               message = "Using cached data - API limit reached. Fresh data in ~$rateLimitMinutes min",
               withDismissAction = true
           )
       }
   }
   ```

8. Add snackbarHost to Scaffold:
   ```kotlin
   Scaffold(
       snackbarHost = { SnackbarHost(snackbarHostState) },
       topBar = { ... }
   )
   ```

Add import for QuotaRepository at top of file:
```kotlin
import com.newsthread.app.data.repository.QuotaRepository
```
  </action>
  <verify>
Build compiles: `gradlew assembleDebug`
Grep for wiring: `grep -n "quotaRepository" app/src/main/java/com/newsthread/app/presentation/feed/FeedScreen.kt`
Grep for Snackbar: `grep -n "SnackbarHost" app/src/main/java/com/newsthread/app/presentation/feed/FeedScreen.kt`
  </verify>
  <done>
FeedViewModel injects QuotaRepository and exposes isRateLimited/rateLimitMinutesRemaining flows.
FeedScreen observes these flows and shows Snackbar when rate limited.
Snackbar message includes time until rate limit expires.
  </done>
</task>

</tasks>

<verification>
1. Code compiles: `gradlew assembleDebug` passes
2. FeedViewModel has QuotaRepository in constructor
3. FeedScreen has SnackbarHost in Scaffold
4. LaunchedEffect triggers Snackbar when isRateLimited = true
5. Snackbar message includes minutes remaining

Manual verification (human):
- Exhaust API quota or mock 429 response
- Observe Snackbar appears with "Using cached data - API limit reached. Fresh data in ~X min"
- Cached articles still display correctly
</verification>

<success_criteria>
- FeedViewModel observes QuotaRepository rate limit state (gap item 1)
- UI shows Snackbar when rate limited (gap item 2)
- Snackbar includes time remaining for user clarity
- Build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
