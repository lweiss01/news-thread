---
phase: 02-text-extraction
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - app/src/main/java/com/newsthread/app/presentation/settings/SettingsViewModel.kt
  - app/src/main/java/com/newsthread/app/presentation/settings/SettingsScreen.kt
autonomous: false

must_haves:
  truths:
    - "User can see current article fetch preference in Settings screen"
    - "User can change fetch preference via radio buttons"
    - "Preference change persists across app restarts"
  artifacts:
    - path: "app/src/main/java/com/newsthread/app/presentation/settings/SettingsViewModel.kt"
      provides: "ViewModel exposing preference state and update function"
      contains: "class SettingsViewModel"
    - path: "app/src/main/java/com/newsthread/app/presentation/settings/SettingsScreen.kt"
      provides: "Settings UI with fetch preference radio buttons"
      contains: "ArticleFetchPreference"
  key_links:
    - from: "SettingsScreen"
      to: "SettingsViewModel"
      via: "hiltViewModel()"
      pattern: "hiltViewModel"
    - from: "SettingsViewModel"
      to: "UserPreferencesRepository"
      via: "Hilt injection"
      pattern: "userPreferencesRepository"
---

<objective>
Create Settings UI for article fetch preference control

Purpose: Users need to control when full article text is fetched to manage data usage. This plan adds the Settings screen UI with radio buttons for WiFi-only/always/never preference, backed by the ViewModel and UserPreferencesRepository.

Output: SettingsViewModel exposing preference state, updated SettingsScreen with fetch preference section.
</objective>

<execution_context>
@C:\Users\lweis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lweis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-extraction/02-RESEARCH.md
@app/src/main/java/com/newsthread/app/presentation/settings/SettingsScreen.kt
@app/src/main/java/com/newsthread/app/domain/model/ArticleFetchPreference.kt
@app/src/main/java/com/newsthread/app/data/repository/UserPreferencesRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsViewModel</name>
  <files>app/src/main/java/com/newsthread/app/presentation/settings/SettingsViewModel.kt</files>
  <action>
Create SettingsViewModel.kt - HiltViewModel exposing user preferences:

```kotlin
package com.newsthread.app.presentation.settings

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.newsthread.app.data.repository.UserPreferencesRepository
import com.newsthread.app.domain.model.ArticleFetchPreference
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.launch
import javax.inject.Inject

/**
 * ViewModel for Settings screen.
 * Exposes user preferences as StateFlow and provides update methods.
 */
@HiltViewModel
class SettingsViewModel @Inject constructor(
    private val userPreferencesRepository: UserPreferencesRepository
) : ViewModel() {

    /**
     * Current article fetch preference.
     * Defaults to WIFI_ONLY while loading from DataStore.
     */
    val articleFetchPreference: StateFlow<ArticleFetchPreference> =
        userPreferencesRepository.articleFetchPreference
            .stateIn(
                scope = viewModelScope,
                started = SharingStarted.WhileSubscribed(5000),
                initialValue = ArticleFetchPreference.WIFI_ONLY
            )

    /**
     * Updates the article fetch preference.
     * Persists to DataStore via repository.
     */
    fun setArticleFetchPreference(preference: ArticleFetchPreference) {
        viewModelScope.launch {
            userPreferencesRepository.setArticleFetchPreference(preference)
        }
    }
}
```

Design notes:
- @HiltViewModel for automatic injection
- StateFlow with WhileSubscribed for lifecycle-aware collection
- initialValue matches repository default (WIFI_ONLY)
- Fire-and-forget launch for preference updates (DataStore handles persistence)
  </action>
  <verify>File exists with @HiltViewModel annotation, articleFetchPreference StateFlow, setArticleFetchPreference function</verify>
  <done>SettingsViewModel exposes articleFetchPreference StateFlow and setArticleFetchPreference() update function</done>
</task>

<task type="auto">
  <name>Task 2: Update SettingsScreen with fetch preference UI</name>
  <files>app/src/main/java/com/newsthread/app/presentation/settings/SettingsScreen.kt</files>
  <action>
Replace the existing placeholder SettingsScreen.kt with a full implementation:

```kotlin
package com.newsthread.app.presentation.settings

import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Wifi
import androidx.compose.material3.Card
import androidx.compose.material3.CardDefaults
import androidx.compose.material3.HorizontalDivider
import androidx.compose.material3.Icon
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.RadioButton
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import com.newsthread.app.domain.model.ArticleFetchPreference

@Composable
fun SettingsScreen(
    viewModel: SettingsViewModel = hiltViewModel()
) {
    val fetchPreference by viewModel.articleFetchPreference.collectAsStateWithLifecycle()

    Column(
        modifier = Modifier
            .fillMaxSize()
            .verticalScroll(rememberScrollState())
            .padding(16.dp)
    ) {
        Text(
            text = "Settings",
            style = MaterialTheme.typography.headlineMedium
        )

        Spacer(modifier = Modifier.height(24.dp))

        // Article Fetch Preference Section
        ArticleFetchPreferenceSection(
            currentPreference = fetchPreference,
            onPreferenceChange = viewModel::setArticleFetchPreference
        )

        Spacer(modifier = Modifier.height(24.dp))

        // Placeholder for future settings sections
        Text(
            text = "More settings coming soon...",
            style = MaterialTheme.typography.bodyMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

@Composable
private fun ArticleFetchPreferenceSection(
    currentPreference: ArticleFetchPreference,
    onPreferenceChange: (ArticleFetchPreference) -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        colors = CardDefaults.cardColors(
            containerColor = MaterialTheme.colorScheme.surfaceVariant
        )
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            Row(
                verticalAlignment = Alignment.CenterVertically
            ) {
                Icon(
                    imageVector = Icons.Default.Wifi,
                    contentDescription = null,
                    tint = MaterialTheme.colorScheme.primary
                )
                Spacer(modifier = Modifier.width(12.dp))
                Column {
                    Text(
                        text = "Article Text Fetching",
                        style = MaterialTheme.typography.titleMedium
                    )
                    Text(
                        text = "Control when full article text is downloaded",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }

            Spacer(modifier = Modifier.height(16.dp))
            HorizontalDivider()
            Spacer(modifier = Modifier.height(8.dp))

            ArticleFetchPreference.entries.forEach { preference ->
                FetchPreferenceOption(
                    preference = preference,
                    isSelected = currentPreference == preference,
                    onClick = { onPreferenceChange(preference) }
                )
            }
        }
    }
}

@Composable
private fun FetchPreferenceOption(
    preference: ArticleFetchPreference,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(vertical = 12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        RadioButton(
            selected = isSelected,
            onClick = onClick
        )
        Spacer(modifier = Modifier.width(12.dp))
        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = preference.displayName(),
                style = MaterialTheme.typography.bodyLarge
            )
            Text(
                text = preference.description(),
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
    }
}

/**
 * Extension function for user-friendly preference display name.
 */
private fun ArticleFetchPreference.displayName(): String = when (this) {
    ArticleFetchPreference.ALWAYS -> "Always"
    ArticleFetchPreference.WIFI_ONLY -> "WiFi only"
    ArticleFetchPreference.NEVER -> "Never"
}

/**
 * Extension function for preference description text.
 */
private fun ArticleFetchPreference.description(): String = when (this) {
    ArticleFetchPreference.ALWAYS -> "Fetch full article text on any network connection"
    ArticleFetchPreference.WIFI_ONLY -> "Only fetch when connected to WiFi (recommended)"
    ArticleFetchPreference.NEVER -> "Never fetch full text, use article summaries only"
}
```

Design notes:
- Uses collectAsStateWithLifecycle for proper lifecycle handling
- Card-based section for visual grouping
- Radio buttons with full-row clickable area for easy touch targets
- Extension functions for preference display strings (keeps enum clean)
- Scrollable for future settings additions
- Material 3 styling with surfaceVariant card background
  </action>
  <verify>SettingsScreen shows fetch preference section with 3 radio button options; selecting an option persists</verify>
  <done>SettingsScreen displays ArticleFetchPreference options as radio buttons; selection updates via ViewModel</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Settings screen with article fetch preference (WiFi-only / Always / Never)</what-built>
  <how-to-verify>
1. Build and run app: `gradlew installDebug`
2. Navigate to Settings tab (bottom navigation)
3. Verify "Article Text Fetching" section is visible with WiFi icon
4. Verify three options displayed: "Always", "WiFi only" (selected by default), "Never"
5. Tap each option - radio button should update immediately
6. Force-stop app and relaunch
7. Navigate to Settings - preference should persist (same option still selected)
8. Verify no crashes or ANRs during navigation
  </how-to-verify>
  <resume-signal>Type "approved" if settings UI works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `gradlew assembleDebug` compiles without errors
2. SettingsViewModel injects UserPreferencesRepository via Hilt
3. SettingsScreen displays fetch preference section
4. Radio button selection persists across app restarts
5. No Compose preview crashes (if applicable)
</verification>

<success_criteria>
- Settings screen shows "Article Text Fetching" card with icon
- Three radio options: Always, WiFi only (default), Never
- Selecting an option updates UI immediately
- Preference persists across app restarts (DataStore)
- Human verification confirms UI is functional
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-extraction/02-04-SUMMARY.md`
</output>
