---
phase: 02-text-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/build.gradle.kts
  - app/src/main/java/com/newsthread/app/domain/model/ExtractionResult.kt
  - app/src/main/java/com/newsthread/app/domain/model/ArticleFetchPreference.kt
  - app/src/main/java/com/newsthread/app/util/PaywallDetector.kt
autonomous: true

must_haves:
  truths:
    - "Readability4J and jsoup libraries are available for article extraction"
    - "Extraction outcomes are modeled as type-safe sealed class"
    - "Paywall detection uses heuristic CSS selectors and text patterns"
  artifacts:
    - path: "app/build.gradle.kts"
      provides: "Readability4J and jsoup dependencies"
      contains: "readability4j"
    - path: "app/src/main/java/com/newsthread/app/domain/model/ExtractionResult.kt"
      provides: "Sealed class for extraction outcomes"
      contains: "sealed class ExtractionResult"
    - path: "app/src/main/java/com/newsthread/app/domain/model/ArticleFetchPreference.kt"
      provides: "Enum for user fetch preference"
      contains: "enum class ArticleFetchPreference"
    - path: "app/src/main/java/com/newsthread/app/util/PaywallDetector.kt"
      provides: "Heuristic paywall detection"
      contains: "fun detectPaywall"
  key_links:
    - from: "PaywallDetector"
      to: "jsoup"
      via: "Jsoup.parse for CSS selector matching"
      pattern: "Jsoup\\.parse"
---

<objective>
Add foundation dependencies and domain models for text extraction

Purpose: Establish the library dependencies (Readability4J for Mozilla Readability algorithm, jsoup for HTML parsing) and create the domain models that will be used throughout the extraction pipeline.

Output: Updated build.gradle.kts with new dependencies, ExtractionResult sealed class, ArticleFetchPreference enum, and PaywallDetector utility.
</objective>

<execution_context>
@C:\Users\lweis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lweis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-extraction/02-RESEARCH.md
@app/build.gradle.kts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Readability4J and jsoup dependencies</name>
  <files>app/build.gradle.kts</files>
  <action>
Add the following dependencies to the dependencies block in app/build.gradle.kts:

```kotlin
// Text Extraction (Phase 2)
implementation("net.dankito.readability4j:readability4j:1.0.8")
implementation("org.jsoup:jsoup:1.17.2")
```

Note: Use jsoup 1.17.2 (latest stable as of early 2024) rather than 1.22.1 mentioned in research (which may be a future version). Readability4J 1.0.8 depends on jsoup internally but we add explicit dependency for PaywallDetector usage.

Place these after the DataStore dependency and before the Testing section, with a comment header for organization.
  </action>
  <verify>Run `gradlew dependencies --configuration debugRuntimeClasspath | grep -E "(readability|jsoup)"` - should show both dependencies</verify>
  <done>readability4j:1.0.8 and jsoup are in dependency tree</done>
</task>

<task type="auto">
  <name>Task 2: Create domain models for extraction</name>
  <files>
app/src/main/java/com/newsthread/app/domain/model/ExtractionResult.kt
app/src/main/java/com/newsthread/app/domain/model/ArticleFetchPreference.kt
  </files>
  <action>
Create ExtractionResult.kt - a sealed class for type-safe extraction outcomes:

```kotlin
package com.newsthread.app.domain.model

/**
 * Sealed class representing the outcome of article text extraction.
 * Enables exhaustive when() handling for all extraction scenarios.
 */
sealed class ExtractionResult {
    /**
     * Successfully extracted article content.
     */
    data class Success(
        val textContent: String,
        val htmlContent: String?,
        val title: String?,
        val byline: String?,
        val excerpt: String?
    ) : ExtractionResult()

    /**
     * Paywall detected - extraction returned insufficient content.
     */
    data class PaywallDetected(
        val reason: String
    ) : ExtractionResult()

    /**
     * Network error during HTML fetch.
     */
    data class NetworkError(
        val message: String
    ) : ExtractionResult()

    /**
     * Parsing/extraction error after HTML was fetched.
     */
    data class ExtractionError(
        val message: String
    ) : ExtractionResult()

    /**
     * Extraction not attempted due to user preference or network state.
     */
    data class NotFetched(
        val reason: String
    ) : ExtractionResult()
}
```

Create ArticleFetchPreference.kt - enum for user-controlled fetch behavior:

```kotlin
package com.newsthread.app.domain.model

/**
 * User preference for when to fetch full article text.
 * Controls data usage behavior for article extraction.
 */
enum class ArticleFetchPreference {
    /** Fetch article text on any network connection */
    ALWAYS,

    /** Only fetch article text when connected to WiFi (recommended) */
    WIFI_ONLY,

    /** Never auto-fetch article text, use NewsAPI content only */
    NEVER
}
```
  </action>
  <verify>Files exist at specified paths with correct package declarations</verify>
  <done>ExtractionResult sealed class has Success, PaywallDetected, NetworkError, ExtractionError, NotFetched variants; ArticleFetchPreference enum has ALWAYS, WIFI_ONLY, NEVER values</done>
</task>

<task type="auto">
  <name>Task 3: Create PaywallDetector utility</name>
  <files>app/src/main/java/com/newsthread/app/util/PaywallDetector.kt</files>
  <action>
Create PaywallDetector.kt - heuristic paywall detection using CSS selectors and text patterns:

```kotlin
package com.newsthread.app.util

import org.jsoup.Jsoup

/**
 * Heuristic paywall detector using CSS selectors, text patterns, and structured data.
 *
 * Detection is conservative (prefers false negatives over false positives) since
 * fallback to NewsAPI content is acceptable but blocking legitimate content is not.
 */
object PaywallDetector {

    private val PAYWALL_CSS_SELECTORS = listOf(
        ".paywall",
        ".subscription-required",
        ".subscriber-only",
        "#paywall",
        ".tp-modal",              // Piano (common paywall provider)
        ".pf-paywall",            // Paragon
        "[data-testid=\"paywall\"]",
        ".pw-content-paywall",
        ".subscription-wall"
    )

    private val PAYWALL_TEXT_PATTERNS = listOf(
        "subscribe to continue reading",
        "subscription required",
        "subscribers only",
        "premium content",
        "sign in to continue",
        "this content is for subscribers",
        "your free articles",
        "you've reached your limit",
        "create a free account to continue"
    )

    /**
     * Detects if the HTML content contains paywall indicators.
     *
     * Uses three detection strategies:
     * 1. Google structured data (isAccessibleForFree: false)
     * 2. CSS selectors for common paywall elements
     * 3. Text patterns indicating subscription prompts
     *
     * @param html Raw HTML content to analyze
     * @return true if paywall indicators detected, false otherwise
     */
    fun detectPaywall(html: String): Boolean {
        val lowerHtml = html.lowercase()

        // Check for Google structured data paywall indicator
        // https://developers.google.com/search/docs/appearance/structured-data/paywalled-content
        if (lowerHtml.contains("\"isaccessibleforfree\"") &&
            (lowerHtml.contains("\"false\"") || lowerHtml.contains(": false"))) {
            return true
        }

        // Parse HTML for CSS selector checks
        val doc = try {
            Jsoup.parse(html)
        } catch (e: Exception) {
            // If parsing fails, assume no paywall (conservative)
            return false
        }

        // Check CSS selectors for paywall elements
        for (selector in PAYWALL_CSS_SELECTORS) {
            try {
                if (doc.select(selector).isNotEmpty()) {
                    return true
                }
            } catch (e: Exception) {
                // Invalid selector, skip
            }
        }

        // Check text patterns in visible content
        val visibleText = doc.body()?.text()?.lowercase() ?: ""
        for (pattern in PAYWALL_TEXT_PATTERNS) {
            if (visibleText.contains(pattern)) {
                return true
            }
        }

        return false
    }
}
```
  </action>
  <verify>File exists with detectPaywall function that checks structured data, CSS selectors, and text patterns</verify>
  <done>PaywallDetector.detectPaywall(html) returns boolean based on heuristic analysis</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `gradlew assembleDebug` compiles without errors
2. Dependencies resolve: `gradlew dependencies | grep -E "(readability|jsoup)"`
3. All new files have correct package declarations matching directory structure
4. ExtractionResult sealed class is exhaustive (5 variants)
5. ArticleFetchPreference enum has 3 values
6. PaywallDetector is an object (singleton) with detectPaywall function
</verification>

<success_criteria>
- Readability4J 1.0.8 and jsoup are in the dependency tree
- ExtractionResult sealed class provides type-safe outcomes for extraction pipeline
- ArticleFetchPreference enum ready for user settings
- PaywallDetector utility ready to analyze HTML for paywall indicators
- Build compiles successfully with new dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-extraction/02-01-SUMMARY.md`
</output>
