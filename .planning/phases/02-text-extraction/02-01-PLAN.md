---
phase: 02-text-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/build.gradle.kts
  - app/src/main/java/com/newsthread/app/domain/model/ExtractionResult.kt
  - app/src/main/java/com/newsthread/app/domain/model/ArticleFetchPreference.kt
  - app/src/main/java/com/newsthread/app/util/PaywallDetector.kt
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Readability4J and jsoup dependencies are available for article extraction"
    - "ExtractionResult sealed class enables type-safe handling of extraction outcomes"
    - "ArticleFetchPreference enum represents WiFi-only/always/never settings"
    - "PaywallDetector identifies paywalled content using heuristic patterns"
  artifacts:
    - path: "app/build.gradle.kts"
      provides: "Readability4J and jsoup dependencies"
      contains: "readability4j"
    - path: "app/src/main/java/com/newsthread/app/domain/model/ExtractionResult.kt"
      provides: "Sealed class for extraction outcomes"
      contains: "sealed class ExtractionResult"
    - path: "app/src/main/java/com/newsthread/app/domain/model/ArticleFetchPreference.kt"
      provides: "Enum for user fetch preference"
      contains: "enum class ArticleFetchPreference"
    - path: "app/src/main/java/com/newsthread/app/util/PaywallDetector.kt"
      provides: "Heuristic paywall detection"
      contains: "fun detectPaywall"
  key_links:
    - from: "PaywallDetector"
      to: "jsoup"
      via: "HTML parsing for CSS selectors"
      pattern: "Jsoup\\.parse"
---

<objective>
Add Readability4J and jsoup dependencies, create domain models for text extraction results, and implement paywall detection heuristics.

Purpose: Establish the foundation types and detection logic needed by the extraction pipeline. These domain models are pure Kotlin with no Android dependencies, enabling clean separation and testability.

Output:
- build.gradle.kts with Readability4J 1.0.8 and jsoup 1.22.1 dependencies
- ExtractionResult.kt sealed class (Success, PaywallDetected, NetworkError, ExtractionError, NotFetched)
- ArticleFetchPreference.kt enum (ALWAYS, WIFI_ONLY, NEVER)
- PaywallDetector.kt object with heuristic detection
</objective>

<execution_context>
@C:\Users\lweis\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\lweis\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-text-extraction/02-RESEARCH.md

# Existing files to reference
@app/build.gradle.kts
@app/src/main/java/com/newsthread/app/domain/model/ApiQuotaState.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Readability4J and jsoup dependencies</name>
  <files>app/build.gradle.kts</files>
  <action>
Add the following dependencies to the dependencies block in app/build.gradle.kts:

```kotlin
// Article text extraction
implementation("net.dankito.readability4j:readability4j:1.0.8")
implementation("org.jsoup:jsoup:1.22.1")
```

Place them after the DataStore dependency (around line 151) to keep dependencies organized by purpose.
  </action>
  <verify>
Grep the file to confirm dependencies are present:
- Pattern: `readability4j:1.0.8`
- Pattern: `jsoup:1.22.1`
  </verify>
  <done>build.gradle.kts contains Readability4J 1.0.8 and jsoup 1.22.1 dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create domain models and PaywallDetector</name>
  <files>
    app/src/main/java/com/newsthread/app/domain/model/ExtractionResult.kt
    app/src/main/java/com/newsthread/app/domain/model/ArticleFetchPreference.kt
    app/src/main/java/com/newsthread/app/util/PaywallDetector.kt
  </files>
  <action>
Create three files:

**ExtractionResult.kt** - Sealed class for type-safe extraction outcomes:
```kotlin
package com.newsthread.app.domain.model

sealed class ExtractionResult {
    data class Success(
        val textContent: String,
        val htmlContent: String?,
        val title: String?,
        val byline: String?,
        val excerpt: String?
    ) : ExtractionResult()

    data class PaywallDetected(
        val reason: String
    ) : ExtractionResult()

    data class NetworkError(
        val message: String
    ) : ExtractionResult()

    data class ExtractionError(
        val message: String
    ) : ExtractionResult()

    data class NotFetched(
        val reason: String  // e.g., "WiFi-only mode, on metered network"
    ) : ExtractionResult()
}
```

**ArticleFetchPreference.kt** - Enum for user's fetch preference:
```kotlin
package com.newsthread.app.domain.model

enum class ArticleFetchPreference {
    ALWAYS,     // Fetch on any network
    WIFI_ONLY,  // Fetch only on unmetered (WiFi/Ethernet)
    NEVER       // Never auto-fetch, use NewsAPI content only
}
```

**PaywallDetector.kt** - Heuristic paywall detection using jsoup:
```kotlin
package com.newsthread.app.util

import org.jsoup.Jsoup

object PaywallDetector {

    private val PAYWALL_CSS_SELECTORS = listOf(
        ".paywall",
        ".subscription-required",
        ".subscriber-only",
        "#paywall",
        ".tp-modal",          // Piano (common paywall provider)
        ".pf-paywall",        // Paragon
        "[data-testid=\"paywall\"]"
    )

    private val PAYWALL_TEXT_PATTERNS = listOf(
        "subscribe to continue reading",
        "subscription required",
        "subscribers only",
        "premium content",
        "register to read",
        "sign in to continue",
        "this content is for subscribers",
        "your free articles"
    )

    /**
     * Detects if HTML content contains paywall indicators.
     * Uses structured data (isAccessibleForFree), CSS selectors, and text patterns.
     *
     * @param html Raw HTML content from article URL
     * @return true if paywall indicators detected, false otherwise
     */
    fun detectPaywall(html: String): Boolean {
        val lowerHtml = html.lowercase()

        // Check for structured data paywall indicator (Google schema)
        if (lowerHtml.contains("\"isaccessibleforfree\"") &&
            lowerHtml.contains("false")) {
            return true
        }

        // Parse HTML and check CSS selectors
        val doc = Jsoup.parse(html)
        for (selector in PAYWALL_CSS_SELECTORS) {
            if (doc.select(selector).isNotEmpty()) {
                return true
            }
        }

        // Check text patterns in visible content
        val visibleText = doc.body()?.text()?.lowercase() ?: ""
        for (pattern in PAYWALL_TEXT_PATTERNS) {
            if (visibleText.contains(pattern)) {
                return true
            }
        }

        return false
    }
}
```
  </action>
  <verify>
Verify each file exists and contains expected content:
- ExtractionResult.kt contains "sealed class ExtractionResult"
- ArticleFetchPreference.kt contains "enum class ArticleFetchPreference"
- PaywallDetector.kt contains "fun detectPaywall" and "Jsoup.parse"
  </verify>
  <done>
- ExtractionResult sealed class has 5 variants: Success, PaywallDetected, NetworkError, ExtractionError, NotFetched
- ArticleFetchPreference enum has 3 values: ALWAYS, WIFI_ONLY, NEVER
- PaywallDetector uses jsoup to check CSS selectors and text patterns
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify dependencies added:
   - Grep build.gradle.kts for "readability4j:1.0.8"
   - Grep build.gradle.kts for "jsoup:1.22.1"

2. Verify domain models created:
   - ExtractionResult.kt exists with sealed class
   - ArticleFetchPreference.kt exists with enum
   - PaywallDetector.kt exists with detectPaywall function

3. Verify no syntax errors (check file structure is valid Kotlin)
</verification>

<success_criteria>
- build.gradle.kts includes Readability4J 1.0.8 and jsoup 1.22.1
- ExtractionResult.kt defines Success, PaywallDetected, NetworkError, ExtractionError, NotFetched variants
- ArticleFetchPreference.kt defines ALWAYS, WIFI_ONLY, NEVER values
- PaywallDetector.kt uses jsoup for CSS selector checks and text pattern matching
- All files compile (valid Kotlin syntax)
</success_criteria>

<output>
After completion, create `.planning/phases/02-text-extraction/02-01-SUMMARY.md`
</output>
