---
id: "06-03"
name: "Scheduling & Settings Integration"
wave: "2"
depends_on: ["06-02"]
files_snapshot:
  - "app/src/main/java/com/newsthread/app/presentation/settings/SettingsScreen.kt"
  - "app/src/main/java/com/newsthread/app/presentation/settings/SettingsViewModel.kt"
  - "app/src/main/java/com/newsthread/app/data/repository/UserPreferencesRepository.kt"
---

<objective>
Implement the "Background Sync Strategy" settings UI and hook up the WorkManager scheduling logic. This includes the new Data Usage toggle with a non-intrusive warning message.
</objective>

<context>
Users need control over background behavior. We will add a "Background Sync" section to `SettingsScreen`.
Top-level toggle: "Allow Background Sync".
If ON, show:
- Strategy: [Performance | Balanced | Power Saver]
- Toggle: "Sync over Metered Connections"
  - *Subtext*: "Data costs may apply" (per user request: just text, no popup).

When settings change, `UserPreferencesRepository` updates, and we observe these changes to re-schedule WorkManager.
</context>

<tasks>
  <task id="prefs_repo" name="Update Preferences Repository">
    <description>
      Add new preferences:
      - `backgroundSyncEnabled`: Boolean (default true)
      - `syncStrategy`: Enum/String (Performance, Balanced, PowerSaver) (default Balanced)
      - `meteredSyncAllowed`: Boolean (default false)
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/data/repository/UserPreferencesRepository.kt">
      <!-- implementation detail: DataStore keys and Flow exposure -->
    </action>
  </task>

  <task id="scheduler" name="Implement Work Scheduler">
    <description>
      Create `BackgroundWorkScheduler` (or add to `NewsRepository` / standalone class).
      It observes preferences.
      
      Logic:
      - If `backgroundSyncEnabled` is false: `WorkManager.cancelUniqueWork(...)`
      - If true:
        - Determine constraints based on Strategy + Metered setting.
        - Determine frequency (15m, 30m, 1h).
        - `enqueueUniquePeriodicWork(..., UPDATE, ...)`
    </description>
    <action type="create" path="app/src/main/java/com/newsthread/app/worker/BackgroundWorkScheduler.kt" />
  </task>

  <task id="settings_ui" name="Update Settings UI">
    <description>
      Add "Background Sync" section to `SettingsScreen.kt`.
      
      UI:
      - Switch: "Background Analysis"
      - (If On) Dropdown/Radio: "Strategy"
        - Performance (15m, >15% battery)
        - Balanced (15m, >30% battery)
        - Power Saver (1h, Charging or >80%)
      - (If On) Switch: "Use Mobile Data"
        - Support text: "Allow syncing when not on WiFi. Data costs may apply."
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/presentation/settings/SettingsScreen.kt" />
  </task>

  <task id="vm_integration" name="Wire up ViewModel">
    <description>
      Update `SettingsViewModel` to expose these new preferences and handle user actions.
      The Scheduler should observe the Repo flow, so ViewModel just saves to Repo.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/presentation/settings/SettingsViewModel.kt" />
  </task>
</tasks>

<verification>
  <must_have>
    - [ ] Settings screen shows new Background Sync options
    - [ ] "Use Mobile Data" has warnings text "Data costs may apply" below it
    - [ ] Changing settings triggers WorkManager re-scheduling (verify logs)
    - [ ] "Balanced" mode sets constraint BatteryNotLow (implied >20%, actual >30% check might need custom logic or just rely on system LowBattery signal which is usually 15-20%)
      - *Refinement*: WorkManager `RequiresBatteryNotLow` is fixed system standard.
      - User asked for >30%. To enforce strict >30%, we might need a custom check inside `doWork()`: `if (battery < 30) return Result.retry()`.
      - **Plan Update**: Add logic to Worker to check battery % for Balanced strategy specifically.
  </must_have>

  <manual_test>
    1. Go to Settings.
    2. Toggle "Allow Background Sync".
    3. Change Strategy to "Balanced".
    4. Enable "Use Mobile Data" -> Verify warning text.
    5. Check Logcat for "Work scheduled".
  </manual_test>
</verification>
