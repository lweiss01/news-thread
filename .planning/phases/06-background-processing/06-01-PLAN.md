---
id: "06-01"
name: "WorkManager Infrastructure"
wave: "1"
depends_on: []
files_snapshot:
  - "app/src/main/java/com/newsthread/app/NewsThreadApp.kt"
  - "app/src/main/AndroidManifest.xml"
  - "app/build.gradle.kts"
---

<objective>
Configure the application for Hilt-injected WorkManager. This establishes the foundation for background processing by disabling the default WorkManager initializer and providing a custom `Configuration.Provider` that uses `HiltWorkerFactory`.
</objective>

<context>
We are using Hilt for dependency injection. WorkManager's default initialization uses a default factory that cannot inject dependencies. We must override this to use `HiltWorkerFactory` so our workers can receive repositories (NewsRepository, etc.).
</context>

<tasks>
  <task id="deps" name="Verify Dependencies">
    <description>
      Ensure `androidx.work:work-runtime-ktx` and `androidx.hilt:hilt-work` are present and compatible.
      (Already verified in Research phase, but good to double check `kapt`/`ksp` configuration for Hilt worker).
    </description>
    <action type="read" path="app/build.gradle.kts" />
  </task>

  <task id="manifest" name="Disable Default Initializer">
    <description>
      Remove the default `WorkManagerInitializer` from `AndroidManifest.xml` using `tools:node="remove"`.
      This prevents WorkManager from starting with the wrong configuration before we can provide ours.
    </description>
    <action type="modify" path="app/src/main/AndroidManifest.xml">
      <diff>
        <![CDATA[
    <application
        android:name=".NewsThreadApp"
        ...>
        
        <!-- Disable default WorkManager Initializer -->
        <provider
            android:name="androidx.startup.InitializationProvider"
            android:authorities="${applicationId}.androidx-startup"
            tools:node="merge">
            <meta-data
                android:name="androidx.work.WorkManagerInitializer"
                android:value="androidx.startup"
                tools:node="remove" />
        </provider>

        <activity ...>
        ]]>
      </diff>
    </action>
  </task>

  <task id="app_config" name="Configure Application Class">
    <description>
      Implement `Configuration.Provider` in `NewsThreadApp`.
      Inject `HiltWorkerFactory` and return a `Configuration` that uses it.
      Set logging level to INFO (or DEBUG in debug builds if desired).
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/NewsThreadApp.kt">
      <diff>
        <![CDATA[
import androidx.work.Configuration
import androidx.hilt.work.HiltWorkerFactory
import javax.inject.Inject

@HiltAndroidApp
class NewsThreadApp : Application(), Configuration.Provider {

    @Inject lateinit var workerFactory: HiltWorkerFactory

    override val workManagerConfiguration: Configuration
        get() = Configuration.Builder()
            .setWorkerFactory(workerFactory)
            .setMinimumLoggingLevel(if (BuildConfig.DEBUG) android.util.Log.DEBUG else android.util.Log.INFO)
            .build()

    override fun onCreate() { ... }
}
        ]]>
      </diff>
    </action>
  </task>
</tasks>

<verification>
  <must_have>
    - [ ] `NewsThreadApp` implements `Configuration.Provider`
    - [ ] `AndroidManifest.xml` contains the `tools:node="remove"` provider entry
    - [ ] App builds successfully without duplicate manifest entry errors
    - [ ] App launches without crashing (WorkManager initializes lazily or on first use)
  </must_have>
  
  <manual_test>
    1. Build and install the app.
    2. Check Logcat for "WorkManager" tag.
    3. You shouldn't see "WorkManager is already initialized" warnings if done correctly.
    4. (We can't test worker injection yet until we create a worker in 06-02).
  </manual_test>
</verification>
