---
id: "09-02"
name: "Thread Visualization Updates"
wave: "2"
depends_on: ["09-01"]
files_snapshot:
  - "app/src/main/java/com/newsthread/app/presentation/tracking/TrackingScreen.kt"
  - "app/src/main/java/com/newsthread/app/presentation/tracking/TrackingViewModel.kt"
  - "app/src/main/java/com/newsthread/app/data/local/entity/StoryEntity.kt"
  - "app/src/main/java/com/newsthread/app/data/local/dao/StoryDao.kt"
---

<objective>
Enhance the Tracking screen to display story updates with bias breakdown, "new articles" badges, and expandable timeline view. Users see at a glance which stories have new coverage and from which perspective.
</objective>

<context>
Phase 8 delivered basic story cards in TrackingScreen. This plan enhances the UI per 09-CONTEXT.md:
- Hybrid summary cards: "3 new articles: 1 Left, 2 Center"
- Expandable chronological timeline
- Pull-to-refresh for manual sync
- Consistent with existing bias spectrum visuals from Phase 7
</context>

<tasks>
  <task id="entity_update" name="Add lastViewedAt to StoryEntity">
    <description>
      Track when user last viewed a story to calculate unread count.
      This enables "N new articles" badge.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/data/local/entity/StoryEntity.kt">
      <diff>
        <![CDATA[
@Entity(tableName = "stories")
data class StoryEntity(
    @PrimaryKey
    val id: String,
    val title: String,
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis(),
    val lastViewedAt: Long = System.currentTimeMillis() // NEW: for unread count
)
        ]]>
      </diff>
    </action>
    <action type="note">
      Room migration required: Add column with default value. See Phase 1 migration patterns.
    </action>
  </task>

  <task id="dao_unread" name="Add Unread Count Query">
    <description>
      Compute unread articles count in StoryWithArticles for badge display.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/data/local/dao/StoryDao.kt">
      <diff>
        <![CDATA[
// Update StoryWithArticles with computed property
data class StoryWithArticles(
    @Embedded val story: StoryEntity,
    @Relation(
        parentColumn = "id",
        entityColumn = "storyId"
    )
    val articles: List<CachedArticleEntity>
) {
    val unreadCount: Int 
        get() = articles.count { it.cachedAt > story.lastViewedAt }
    
    val biasSummary: Map<Int, Int>
        get() = articles
            .mapNotNull { it.biasScore?.toInt() }
            .groupingBy { it }
            .eachCount()
}

// Add method to update lastViewedAt
@Query("UPDATE stories SET lastViewedAt = :timestamp WHERE id = :storyId")
suspend fun markStoryViewed(storyId: String, timestamp: Long = System.currentTimeMillis())
        ]]>
      </diff>
    </action>
  </task>

  <task id="viewmodel" name="Extend TrackingViewModel">
    <description>
      Add pull-to-refresh trigger and mark-as-viewed action.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/presentation/tracking/TrackingViewModel.kt">
      <diff>
        <![CDATA[
import androidx.work.OneTimeWorkRequestBuilder
import androidx.work.WorkManager
import com.newsthread.app.worker.StoryUpdateWorker

// Add refresh state
private val _isRefreshing = MutableStateFlow(false)
val isRefreshing: StateFlow<Boolean> = _isRefreshing.asStateFlow()

// Trigger manual refresh
fun refresh() {
    viewModelScope.launch {
        _isRefreshing.value = true
        
        // Trigger one-time story update
        val request = OneTimeWorkRequestBuilder<StoryUpdateWorker>().build()
        WorkManager.getInstance(application).enqueue(request)
        
        // Wait briefly for worker to complete
        delay(2000)
        _isRefreshing.value = false
    }
}

// Mark story as viewed (clears unread badge)
fun markStoryViewed(storyId: String) {
    viewModelScope.launch {
        trackingRepository.markStoryViewed(storyId)
    }
}
        ]]>
      </diff>
    </action>
  </task>

  <task id="enhanced_card" name="Create EnhancedStoryCard">
    <description>
      Build the hybrid summary card with:
      - Story title
      - "N new articles" badge with bias breakdown
      - Expandable timeline
      - Visual indicators for new perspectives
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/presentation/tracking/TrackingScreen.kt">
      <diff>
        <![CDATA[
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.foundation.background
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.icons.filled.ExpandLess
import androidx.compose.material.icons.filled.ExpandMore
import androidx.compose.material.icons.filled.NewReleases
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.ui.graphics.Color
import com.google.accompanist.swiperefresh.SwipeRefresh
import com.google.accompanist.swiperefresh.rememberSwipeRefreshState

// Bias category colors (matches Phase 7 spectrum)
private val biasColors = mapOf(
    -2 to Color(0xFF1565C0), // Far Left - Deep Blue
    -1 to Color(0xFF42A5F5), // Left - Light Blue
    0 to Color(0xFF9E9E9E),  // Center - Gray
    1 to Color(0xFFEF5350),  // Right - Light Red
    2 to Color(0xFFB71C1C)   // Far Right - Deep Red
)

@Composable
fun EnhancedStoryCard(
    storyWithArticles: StoryWithArticles,
    onUnfollow: (String) -> Unit,
    onArticleClick: (String) -> Unit,
    onMarkViewed: (String) -> Unit
) {
    var expanded by remember { mutableStateOf(false) }
    val unreadCount = storyWithArticles.unreadCount
    val biasSummary = storyWithArticles.biasSummary

    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clickable {
                expanded = !expanded
                if (expanded) onMarkViewed(storyWithArticles.story.id)
            }
    ) {
        Column(modifier = Modifier.padding(16.dp)) {
            // Header row
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column(modifier = Modifier.weight(1f)) {
                    Text(
                        text = storyWithArticles.story.title,
                        style = MaterialTheme.typography.titleMedium
                    )
                    
                    // Unread badge with bias breakdown
                    if (unreadCount > 0) {
                        Row(
                            verticalAlignment = Alignment.CenterVertically,
                            modifier = Modifier.padding(top = 4.dp)
                        ) {
                            Icon(
                                imageVector = Icons.Default.NewReleases,
                                contentDescription = null,
                                tint = MaterialTheme.colorScheme.primary,
                                modifier = Modifier.size(16.dp)
                            )
                            Spacer(modifier = Modifier.width(4.dp))
                            Text(
                                text = "$unreadCount new: ",
                                style = MaterialTheme.typography.bodySmall,
                                color = MaterialTheme.colorScheme.primary
                            )
                            BiasSummaryChips(biasSummary)
                        }
                    }
                }
                
                Row {
                    IconButton(onClick = { expanded = !expanded }) {
                        Icon(
                            imageVector = if (expanded) Icons.Default.ExpandLess else Icons.Default.ExpandMore,
                            contentDescription = if (expanded) "Collapse" else "Expand"
                        )
                    }
                    IconButton(onClick = { onUnfollow(storyWithArticles.story.id) }) {
                        Icon(
                            imageVector = Icons.Default.Delete,
                            contentDescription = "Unfollow"
                        )
                    }
                }
            }

            // Expandable timeline
            AnimatedVisibility(visible = expanded) {
                Column(modifier = Modifier.padding(top = 12.dp)) {
                    Divider()
                    Spacer(modifier = Modifier.height(8.dp))
                    
                    storyWithArticles.articles
                        .sortedByDescending { it.cachedAt }
                        .forEach { article ->
                            ArticleTimelineItem(
                                article = article,
                                isNew = article.cachedAt > storyWithArticles.story.lastViewedAt,
                                onClick = { onArticleClick(article.url) }
                            )
                        }
                }
            }
        }
    }
}

@Composable
fun BiasSummaryChips(biasSummary: Map<Int, Int>) {
    Row(horizontalArrangement = Arrangement.spacedBy(4.dp)) {
        biasSummary.entries.sortedBy { it.key }.forEach { (bias, count) ->
            Box(
                modifier = Modifier
                    .background(
                        color = biasColors[bias] ?: Color.Gray,
                        shape = RoundedCornerShape(4.dp)
                    )
                    .padding(horizontal = 6.dp, vertical = 2.dp)
            ) {
                Text(
                    text = count.toString(),
                    style = MaterialTheme.typography.labelSmall,
                    color = Color.White
                )
            }
        }
    }
}

@Composable
fun ArticleTimelineItem(
    article: CachedArticleEntity,
    isNew: Boolean,
    onClick: () -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(vertical = 6.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        // Bias indicator dot
        Box(
            modifier = Modifier
                .size(8.dp)
                .background(
                    color = biasColors[article.biasScore?.toInt()] ?: Color.Gray,
                    shape = CircleShape
                )
        )
        
        Spacer(modifier = Modifier.width(12.dp))
        
        Column(modifier = Modifier.weight(1f)) {
            Text(
                text = article.title,
                style = MaterialTheme.typography.bodyMedium,
                fontWeight = if (isNew) FontWeight.Bold else FontWeight.Normal
            )
            Text(
                text = article.sourceName ?: "Unknown source",
                style = MaterialTheme.typography.bodySmall,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )
        }
        
        if (isNew) {
            Badge { Text("New") }
        }
    }
}
        ]]>
      </diff>
    </action>
  </task>

  <task id="pull_refresh" name="Add Pull-to-Refresh">
    <description>
      Wrap TrackingScreen content in SwipeRefresh for manual story sync.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/presentation/tracking/TrackingScreen.kt">
      <diff>
        <![CDATA[
// Update TrackingScreen composable
@Composable
fun TrackingScreen(
    onArticleClick: (String) -> Unit,
    viewModel: TrackingViewModel = hiltViewModel()
) {
    val stories by viewModel.trackedStories.collectAsState()
    val isRefreshing by viewModel.isRefreshing.collectAsState()

    Scaffold(
        topBar = {
            TopAppBar(title = { Text("Tracked Stories") })
        }
    ) { padding ->
        SwipeRefresh(
            state = rememberSwipeRefreshState(isRefreshing),
            onRefresh = { viewModel.refresh() },
            modifier = Modifier.padding(padding)
        ) {
            if (stories.isEmpty()) {
                EmptyTrackingState()
            } else {
                LazyColumn(
                    contentPadding = PaddingValues(16.dp),
                    verticalArrangement = Arrangement.spacedBy(16.dp)
                ) {
                    items(stories, key = { it.story.id }) { storyWithArticles ->
                        EnhancedStoryCard(
                            storyWithArticles = storyWithArticles,
                            onUnfollow = { viewModel.unfollowStory(it) },
                            onArticleClick = onArticleClick,
                            onMarkViewed = { viewModel.markStoryViewed(it) }
                        )
                    }
                }
            }
        }
    }
}
        ]]>
      </diff>
    </action>
  </task>

  <task id="migration" name="Database Migration">
    <description>
      Add Room migration for the new lastViewedAt column.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/data/local/NewsDatabase.kt">
      <diff>
        <![CDATA[
val MIGRATION_X_Y = object : Migration(X, Y) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL(
            "ALTER TABLE stories ADD COLUMN lastViewedAt INTEGER NOT NULL DEFAULT 0"
        )
    }
}
        ]]>
      </diff>
    </action>
  </task>
</tasks>

<verification>
  <must_have>
    - [ ] `StoryEntity` has `lastViewedAt` field
    - [ ] `StoryWithArticles` computes `unreadCount` and `biasSummary`
    - [ ] `EnhancedStoryCard` shows "N new: [bias chips]" when unread > 0
    - [ ] Cards expand to show chronological article timeline
    - [ ] Pull-to-refresh triggers one-time `StoryUpdateWorker`
    - [ ] Expanding card marks story as viewed (clears badge)
    - [ ] Bias chips use Phase 7 spectrum colors
    - [ ] Room migration handles `lastViewedAt` column addition
    - [ ] App builds successfully
  </must_have>

  <unit_tests>
    Run existing tests:
    ```bash
    ./gradlew test --tests "com.newsthread.app.data.repository.TrackingRepositoryTest"
    ```
  </unit_tests>

  <manual_test>
    1. Build and install app
    2. Track 2-3 articles in feed
    3. Wait for StoryUpdateWorker to run (or force via ADB)
    4. Open Tracking tab
    5. Verify story cards show "N new: [colored chips]" for updates
    6. Pull down to refresh — verify loading indicator
    7. Tap card to expand — verify timeline with bias dots
    8. Close and reopen — verify badge cleared after viewing
  </manual_test>
</verification>
