# 04-01-PLAN: Semantic Similarity Engine

## Objective

Replace keyword-based entity matching in `ArticleMatchingRepositoryImpl` with cosine similarity on Phase 3 embeddings. Implement dynamic time windows and feed-internal matching.

## Context

The current matching approach uses extracted entities and title similarity with hardcoded 10-100% thresholds. Phase 3 delivered the embedding infrastructure (`EmbeddingRepository`, `EmbeddingEngine`). This plan integrates them for semantic matching per `04-CONTEXT.md`.

## Design Decisions

- **Keyword fallback:** Keep existing entity extraction as fallback when embeddings fail (OOM, model error, no text)
- **Combined scope:** All Phase 4 work (feed matching, API search, time windows) in this single plan
- **Tiered API strategy:** Feed-internal first → NewsAPI only if <3 matches AND quota available

## Wave 1: Core Similarity Infrastructure

### [NEW] SimilarityMatcher.kt

`app/src/main/java/com/newsthread/app/domain/similarity/SimilarityMatcher.kt`

**Purpose:** Compute cosine similarity between embeddings.

```kotlin
@Singleton
class SimilarityMatcher @Inject constructor() {
    // Core cosine similarity: dot(a,b) / (norm(a) * norm(b))
    fun cosineSimilarity(a: FloatArray, b: FloatArray): Float
    
    // Match strength per 04-CONTEXT.md thresholds
    fun matchStrength(similarity: Float): MatchStrength  // STRONG (≥0.70), WEAK (0.50-0.69), NONE (<0.50)
}

enum class MatchStrength { STRONG, WEAK, NONE }
```

---

### [NEW] TimeWindowCalculator.kt

`app/src/main/java/com/newsthread/app/domain/similarity/TimeWindowCalculator.kt`

**Purpose:** Calculate dynamic match windows based on article age.

```kotlin
@Singleton
class TimeWindowCalculator @Inject constructor() {
    // Returns (fromDate, toDate) based on article age
    // <24 hours: ±48 hours
    // 1-7 days: ±7 days  
    // 7+ days: ±14 days
    fun calculateWindow(articleDate: Instant): Pair<Instant, Instant>
}
```


---

### [MODIFY] ArticleMatchingRepositoryImpl.kt

`app/src/main/java/com/newsthread/app/domain/repository/ArticleMatchingRepositoryImpl.kt`

**Changes:**

1. **Inject new dependencies:** `SimilarityMatcher`, `TimeWindowCalculator`, `EmbeddingRepository`

2. **Replace entity-based filtering** in `searchAndMatch()` with:
   - Get embedding for source article via `EmbeddingRepository`
   - Get embeddings for candidates (batch via `getByArticleUrls()`)
   - Filter by `SimilarityMatcher.cosineSimilarity()` ≥ 0.50
   - Sort by similarity score descending

3. **Use dynamic time windows:**
   - Replace hardcoded 7-day window with `TimeWindowCalculator.calculateWindow()`

4. **Add feed-internal matching:**
   - Before NewsAPI search, check cached articles in `CachedArticleDao.getAll()`
   - Compute similarity against all cached articles
   - Only hit NewsAPI if <3 matches found

5. **Store similarity score** in match results for later UI display (if needed)

**Key logic change in `findSimilarArticles()`:**

```kotlin
// NEW: Get source embedding
val sourceEmbedding = embeddingRepository.getOrGenerateEmbedding(article.url)
if (sourceEmbedding == null) {
    // Fallback to keyword matching (existing logic)
    ...
}

// NEW: Feed-internal matching first
val cachedArticles = cachedArticleDao.getAll()
val feedMatches = findSemanticMatches(sourceEmbedding, cachedArticles)
allMatches.addAll(feedMatches)

// Only search NewsAPI if <3 matches
if (allMatches.size < 3 && quotaAvailable) {
    val apiMatches = searchSemanticMatches(sourceEmbedding, query, fromDate, toDate)
    allMatches.addAll(apiMatches)
}
```

---

## Wave 2: Match Result Enhancements

### [MODIFY] MatchResultEntity.kt

`app/src/main/java/com/newsthread/app/data/local/entity/MatchResultEntity.kt`

**Add field:**
```kotlin
val matchScoresJson: String = "[]"  // JSON array of similarity scores, parallel to matchedArticleUrlsJson
```

---

### [MODIFY] MatchResultDao.kt

Update any queries if needed for new field.

---

## Verification Plan

### Unit Tests

**Command:** `./gradlew :app:testDebugUnitTest --tests "com.newsthread.app.domain.similarity.*"`

| Test | Coverage |
|------|----------|
| `SimilarityMatcherTest.cosineSimilarity_identicalVectors_returns1` | Identical embeddings → 1.0 |
| `SimilarityMatcherTest.cosineSimilarity_orthogonalVectors_returns0` | Unrelated embeddings → 0.0 |
| `SimilarityMatcherTest.matchStrength_thresholds` | 0.70+ = STRONG, 0.50-0.69 = WEAK, <0.50 = NONE |
| `TimeWindowCalculatorTest.calculateWindow_breakingNews` | <24h → ±48h window |
| `TimeWindowCalculatorTest.calculateWindow_recentNews` | 1-7d → ±7d window |
| `TimeWindowCalculatorTest.calculateWindow_oldNews` | 7+d → ±14d window |

### Integration Tests (Device)

**FT-1: Semantic Match Quality**
1. Open an article (e.g. "Trump tariffs on China")
2. Tap "Compare"
3. Verify: Matched articles are semantically related (same topic, not just keyword overlap)
4. Note: NewsAPI quota may limit results

**FT-2: Feed-Internal Matching**
1. Scroll feed to load articles
2. Open an article that has related articles in the same feed
3. Tap "Compare"
4. Verify: Matches include articles from the feed (no API call needed)

**FT-3: Dynamic Time Windows**
1. Open a 1-day-old article → expect matches within ±7 days
2. Open a 10-day-old article → expect matches within ±14 days

### Manual Verification

User should confirm matching quality improves over current keyword-based approach.

---

## Dependencies

- Phase 3 complete (EmbeddingRepository, EmbeddingEngine)
- `all-MiniLM-L6-v2` model bundled in assets

## Estimated Duration

~60-90 minutes (2 waves)
