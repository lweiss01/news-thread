---
id: "09.5-02"
name: "Feed Quality & UI Cleanup"
wave: "1"
depends_on: ["09.5-01"]
files_snapshot:
  - "app/src/main/java/com/newsthread/app/data/repository/NewsRepositoryImpl.kt"
  - "app/src/main/java/com/newsthread/app/ui/feed/FeedViewModel.kt"
  - "app/src/main/java/com/newsthread/app/domain/model/SourceRating.kt"
---

<objective>
Improve the quality of the main news feed by filtering out low-quality/unrated sources and fixing UI regressions.
1.  **Spam Filtering**: Remove unrated and low-rated sources from the main feed.
2.  **Trusted Sources**: Ensure major outlets (NYT, BBC, etc.) are prioritized or at least present.
3.  **UI Fixes**: Restore missing source badges (reliability shields/bias icons).
</objective>

<context>
The "Everything" endpoint from NewsAPI returns a lot of noise (e.g., Slashdot, random blogs). Users report the feed feels "spammy" and lacks trusted sources. Additionally, the source reliability badges have disappeared from the UI, making it harder to judge source quality at a glance.

**Critical Issues:**
- `newsthread-spam`: Unrated sources (Slashdot, etc.) over-represented.
- `newsthread-quality`: Trusted sources missing.
- `newsthread-ui`: Source rating badges missing.
</context>

<tasks>
  <task id="source_filtering" name="Implement Source Quality Filter">
    <description>
      Modify `NewsRepository` (or use case) to filter articles based on `SourceRating`.
      - **Rule 1**: If a source is NOT in our database (unrated), filter it out of the Main Feed (keep it for specific searches).
      - **Rule 2**: If a source has a low reliability score (if we have that data), filter it out.
      - **Allow List**: Add a hardcoded "Safe List" for major sources if they are missing from our DB.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/data/repository/NewsRepositoryImpl.kt">
      <diff>
        <![CDATA[
// In getNewsFeed():
// Filter attributes:
// val isRated = sourceRatingDao.isRated(article.source.id)
// if (!isRated) continue
        ]]>
      </diff>
    </action>
  </task>

  <task id="api_endpoint" name="Switch to Top Headlines & Limit">
    <description>
      1. Switch main feed from `everything` to `top-headlines`.
      2. **Crucial**: Limit fetch size to **20 stories max** to conserve API quota.
      3. **Filter**: Only show articles from **rated sources** in the main feed to ensure quality. Unrated sources should only appear in "Compare Perspectives".
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/data/repository/NewsRepositoryImpl.kt">
      <diff>
        <![CDATA[
// Use getTopHeadlines()
// Apply .take(20) limit on the result
// Filter: sourceRatingDao.isRated(sourceId) == true
        ]]>
      </diff>
    </action>
  </task>

  <task id="ui_badges" name="Fix Source Badges">
    <description>
      Investigate `ArticleCard` and `SourceBadge`. The user reports badges are missing.
      Ensure `FeedViewModel` is mapping the `SourceRating` to the UI model correctly.
      Check if `sourceId` matching between API articles and local DB is consistent.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/ui/components/ArticleCard.kt">
      <diff>
        <![CDATA[
// Verify badge visibility logic
        ]]>
      </diff>
    </action>
  </task>
</tasks>

<verification>
  <manual_test>
    1. **Feed Quality**: Run app, refresh feed. Verify Slashdot and random blogs are GONE.
    2. **Trusted Sources**: Verify major outlets are present (may need to adjust API query if they are still missingâ€”e.g. switch to `top-headlines` if `everything` is too noisy).
    3. **Badges**: Verify every article card has a reliability shield and bias icon.
  </manual_test>
</verification>
