---
id: "09.5-01"
name: "Matching Logic & Updates Fix"
wave: "1"
depends_on: []
files_snapshot:
  - "app/src/main/java/com/newsthread/app/domain/usecase/UpdateTrackedStoriesUseCase.kt"
  - "app/src/main/java/com/newsthread/app/domain/similarity/SimilarityMatcher.kt"
  - "app/src/main/java/com/newsthread/app/ui/tracking/TrackingViewModel.kt"
  - "app/src/main/java/com/newsthread/app/ui/tracking/TrackingScreen.kt"
---

<objective>
Debug and fix critical issues in story tracking:
1.  **Matching Quality**: Fix "misses related stories" (false negatives) and "unrelated matches" (false positives).
2.  **Update Mechanism**: Fix "no updates showing" by verifying worker execution and threshold logic.
3.  **UI Integrity**: Fix disappearing timestamps and missing original story links on the tracking page.
</objective>

<context>
Users report that the auto-matching logic (delivered in Phase 9) is unreliable. The current thresholds (0.70 strong, 0.50 weak) may be miscalibrated for the MobileBERT embeddings. Additionally, state persistence issues in the Tracking UI are causing metadata to vanish.

**Critical Bugs:**
- `newsthread-a83`: Matching misses clearly related stories (Recall issue).
- `newsthread-ops`: Matching includes unrelated stories (Precision issue).
- `newsthread-bug`: Last updated time disappears after navigation.
- `newsthread-bug`: Original story link missing.
</context>

<tasks>
  <task id="instrumentation" name="Instrument Matching Logic">
    <description>
      Add verbose logging to `UpdateTrackedStoriesUseCase` to capture:
      - Centroid calculation details
      - Candidate article similarity scores
      - Rejections (why was a candidate rejected?)
      This is essential to "see" what the model sees and tune thresholds.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/domain/usecase/UpdateTrackedStoriesUseCase.kt">
      <diff>
        <![CDATA[
// Add logging to capturing similarity scores for analysis
Log.d("StoryMatching", "Story $storyId centroid computed from ${storyEmbeddings.size} articles")
// ... inside loop ...
Log.d("StoryMatching", "Candidate ${article.title}: similarity $similarity, strength $strength")
        ]]>
      </diff>
    </action>
  </task>

  <task id="tune_thresholds" name="Tune Similarity Thresholds">
    <description>
      Adjust thresholds based on analysis.
      Hypothesis: 0.70 is too high for "Strong" auto-add.
      Proposed: Lower STRONG to 0.65, Raise WEAK to 0.55 (narrower review band).
      Make thresholds configurable or at least easily adjustable constants.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/domain/similarity/SimilarityMatcher.kt">
      <diff>
        <![CDATA[
companion object {
    // Adjusted thresholds
    const val STRONG_THRESHOLD = 0.65f // Was 0.70
    const val WEAK_THRESHOLD = 0.55f   // Was 0.50
}
        ]]>
      </diff>
    </action>
  </task>

  <task id="ui_fixes" name="Fix Tracking UI State">
    <description>
      Investigate TrackingViewModel and TrackingScreen to ensure `lastUpdated` and `originalStoryUrl` are correctly persisted and mapped to the UI state.
      The issue likely lies in how the `TrackedStory` entity is mapped to the list item model.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/ui/tracking/TrackingViewModel.kt">
      <diff>
        <![CDATA[
// Verify mapping logic in combine() or flow transformations
// Ensure lastUpdated timestamp is preserving the latest update time from the story entity
        ]]>
      </diff>
    </action>
     <action type="modify" path="app/src/main/java/com/newsthread/app/ui/tracking/TrackingScreen.kt">
      <diff>
        <![CDATA[
// Fix clickable modifier on story card to ensure full card touches work
// Ensure original story link is conditionally displayed only when valid
        ]]>
      </diff>
    </action>
  </task>

  <task id="debug_tools" name="Add Debug Trigger">
    <description>
      Add a "Run Sync Now" button in Settings (Debug section) to force-run the `UpdateTrackedStoriesUseCase` immediately.
      This allows instant feedback on matching logic without waiting 2 hours.
    </description>
    <action type="modify" path="app/src/main/java/com/newsthread/app/ui/settings/SettingsScreen.kt">
      <diff>
        <![CDATA[
// Add "Force Story Sync" button in Debug section
// Invokes trackingRepository.syncNow() or equivalent WorkManager enqueue
        ]]>
      </diff>
    </action>
  </task>
</tasks>

<verification>
  <manual_test>
    1. **Instrumentation check**: Run "Force Story Sync" and check Logcat for "StoryMatching" tags. verify similarity scores for known related articles.
    2. **Recall check**: Ensure the "5 duplicate stories" mentioned in the bug report are now picked up (either as strong or weak matches).
    3. **Precision check**: Verify unrelated stories are NOT picked up.
    4. **UI Persistence**: Navigate away from Tracking tab and back. Verify "Last Updated" time persists.
    5. **Link check**: Verify "Original Story" link is visible and clickable.
  </manual_test>
</verification>
