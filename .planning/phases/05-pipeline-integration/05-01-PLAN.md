# 05-01-PLAN: Pipeline Integration

## Objective

Orchestrate the end-to-end matching pipeline (Extraction → Embedding → Similarity) via a new Use Case Layer. Ensure the UI handles the full sequence with clear state management and fallback hints.

## Context

Phase 4 provided the semantic matching engine, but it currently requires text to be present in the database to work. If a user taps "Compare" before a background fetch completes, the app falls back to keyword matching prematurely. Phase 5 bridges this.

## Proposed Changes

### Domain Layer (New Use Case)

#### [NEW] GetSimilarArticlesUseCase.kt
`app/src/main/java/com/newsthread/app/domain/usecase/GetSimilarArticlesUseCase.kt`

**Logic**:
- Injects `TextExtractionRepository` and `ArticleMatchingRepository`.
- If `article.fullText` is blank, calls `extractAndSave`.
- After extraction attempt, calls `findSimilarArticles`.
- Returns a combined flow of results.

### Presentation Layer

#### [MODIFY] ComparisonViewModel.kt
- Uses `GetSimilarArticlesUseCase` instead of `ArticleMatchingRepository`.
- Exposes a `hintMessage` in the UI state if extraction was blocked by settings: *"Perspectives are limited. Connect to WiFi for more perspectives."*

#### [MODIFY] ComparisonScreen.kt
- Shows the hint message (if present) as a non-intrusive alert/text above the results.

## Verification Plan

### Automated Tests
- **GetSimilarArticlesUseCaseTest**: Mockito tests verifying the dependency sequence.

### Manual Verification
- Test "Compare" trigger on non-extracted articles.
- Test "WiFi-only" fallback hint on mobile data: *"Perspectives are limited. Connect to WiFi for more perspectives."*
